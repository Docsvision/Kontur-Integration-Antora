= Настройка модуля интеграции с {uc}

Выпуск сертификата может выполняться двумя способами:

* С использованием личного кабинета {dv}. В таком случае ЛК общий для всех клиентов, выбравших такой вариант.
* С использованием собственного личного кабинета.

Последний выпущенный на сотрудника облачный сертификат записывается в поле _Сертификат_ в профиле сотрудника. При выпуске нового сертификата, старый будет удалён из карточки.

Администратор должен настроить расширение для модуля {bo} в модуле {mc}.

. [[password]]Установите закрытый ключ, полученный от {dv}. В окне установки пароля для контейнера не задавайте пароль, оставьте поле _Новый пароль_ пустым.
+
.Пароль для контейнера
image::container-password.png[Пароль для контейнера]
+
. Сертификат в формате `.cer` из архива {uc} установите в контейнер закрытого ключа по https://support.kontur.ru/ca/38784-kak_ustanovit_lichnyj_sertifikat_cherez_kriptopro#id-%D0%9A%D0%B0%D0%BA%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D1%8C%D0%BB%D0%B8%D1%87%D0%BD%D1%8B%D0%B9%D1%81%D0%B5%D1%80%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D1%87%D0%B5%D1%80%D0%B5%D0%B7%D0%9A%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%9F%D1%80%D0%BE-%D0%A7%D0%B5%D1%80%D0%B5%D0%B7%D0%BC%D0%B5%D0%BD%D1%8E%D0%9A%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%9F%D1%80%D0%BE%C2%AB%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D1%8C%D0%BB%D0%B8%D1%87%D0%BD%D1%8B%D0%B9%D1%81%D0%B5%D1%80%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%C2%BB[инструкции на сайте support.kontur.ru].
. Убедитесь, что корневой сертификат `UC-Cabinet` установлен. Установите сертификат, если он отсутствует.
+
.Сертификат установлен в хранилище
image::cert-installed.png[Сертификат установлен в хранилище]
+
. Удостоверьтесь, что пул {wc} запущен от имени пользователя, под которым вы авторизованы на машине.
+
.Запуск пула от имени пользователя
image::pool-user.png[Запуск пула от имени пользователя]
+
. В справочнике сотрудников для учётной записи пользователя, под которым вы авторизованы на машине, укажите ФИО сотрудника на русском языке без цифр и номер телефона.
+
.Данные о сотруднике
image::employee-dir.png[Данные о сотруднике]
+
. Укажите значение следующих настроек в _Конструкторе справочников_:
+
.Отпечаток сертификата
image::thumbprint.png[Отпечаток сертификата]
+
[source,csharp]
----
CryptoApiConnectionAddress "https://cloudtest.kontur-ca.ru/v3/" <.>
CryptoAuthenticationCertificateThumbprint "2e598518c3c43f6ed2977aaefd2b968c018274a6" <.>
KcrApiConnectionAddress "https://api.kontur.ru/kcr/" <.>
KcrApiKey "a8b07384-4a1a-77fd-c91a-9cf799284db7" <.>
RestClientMaxTimeout "60000" <.>
----
<.> `CryptoApiConnectionAddress` -- точка подключения к КриптоПро.
<.> `CryptoAuthenticationCertificateThumbprint` -- отпечаток сертификата, переданного контуром по заявке.
<.> `KcrApiConnectionAddress` -- точка подключения к API {uc}.
<.> `KcrApiKey` -- API-ключ {uc}.
<.> `RestClientMaxTimeout` -- интервал времени (в миллисекундах), в течение которого будет ожидаться ответ от {uc}. Значение по умолчанию `60` секунд.
+
.Заполненные настройки в конструкторе справочников
image::directory-designer.png[Заполненные настройки в конструкторе справочников]
+
. Подайте заявку на сертификат через DSS клиент:
.. Скачайте и распакуйте архив `DssTestClient.zip`.
.. Запустите файл программы `DssTestClient.exe`.
.. Заполните данные по следующему шаблону:
+
.Данные в окне DSS Client
image::dss-client.png[Данные в окне DSS Client]
+
* _Адрес сервиса {dv}_ -- укажите адрес.
* _ID сотрудника_ -- нажмите кнопку *Текущий*.
* _ИНН_ -- не изменяйте значение.
* Нажмите кнопку *Создать заявку*.
* Нажмите кнопку *Загрузить паспортные данные*.
* Нажмите кнопку *Загрузить скан паспорта*.
* Нажмите кнопку *Скачать заявление*, будет скачан файл.
* Отправьте скачанную скан-копию заявления нажатием кнопки *Отправить скан заявления*.
* *Создать запрос на подтверждение выпуска сертификата в ЕСИА* -- не изменяйте значение.
* Нажмите кнопку *Создать запрос на подтверждение выпуска сертификата в ЕСИА* -- придет смс на телефон, указанный в справочнике сотрудников, ввести код в поле.
* Нажмите кнопку *Отправить заявку на проверку*.
+
Если после нажатия кнопки вы встретили ошибку с кодом 400, рекомендуется подождать минуту, в личном кабинете {uc} изменится статус заявки, затем можно будет продолжить работу.
+
* *Удостоверить личность* -- не изменяйте значение.
* Нажмите кнопку *Загрузить сертификат* -- будет установлен сертификат.
+
. При корректном заполнении данных после нажатия кнопки *Загрузить сертификат* появится следующее информационное окно:
+
.Сертификат установлен пользователю
image::cert-installed-message.png[Сертификат установлен пользователю]
+
. Убедитесь, что в справочнике сотрудников в карточке сотрудника указан сертификат:
+
.Сертификат в карточке сотрудника
image::user-cert.png[Сертификат в карточке сотрудника]
+
. Откройте {wc}.
. Создайте исходящий документ.
. Отправьте документ на согласование.
. Откройте меню подписания.
. Согласитесь выполнить поиск сертификата в облаке:
+
.Поиск сертификата в облаке
image::search-cloud-cert.png[Поиск сертификата в облаке]
+
. Выберите облачный сертификат.
. Нажмите *Подписать*.
+
****
Возникновение ошибки на данном этапе может означать, что
// в журнале `System.Net.WebException: Запрос был прерван: Не удалось создать защищенный канал SSL/TLS.`
вы <<password,установили пароль для контейнера>>.

.Чтобы исправить ошибку, выполните следующие действия:
... Откройте КриптоПро CSP.
... На вкладке _Сервис_ нажмите *Удалить сохранённые пароли*.
... Затем слева нажмите на кнопку *Изменить пароль* и оставьте поле _Пароль_ пустым.
****
+
. Введите код из СМС и нажмите *ОК*:
+
.Введите код из СМС
image::sms.png[Введите код из СМС]
+
. Электронная подпись сформирована успешно.
+
.ЭП сформирована успешно
image::finish.png[ЭП сформирована успешно]

// [#register]
// == Регистрация сертификата
//
//
//
// [#recall]
// == Отзыв сертификата
//
//
//
// [#check]
// == Проверка сертификата
